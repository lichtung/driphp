#!/usr/bin/env bash

# 当前脚本所在目录
HOME_DIR="$( cd "$( dirname "$0"  )" && pwd  )"
ACTION=${1}

ENV=${HOME_DIR}/env.yaml
ENV_SAMPLE=${HOME_DIR}/tests/env.sample.yaml
PHPUNIT=${HOME_DIR}/vendor/bin/phpunit
PHPDOC=${HOME_DIR}/vendor/bin/phpdoc



# 检查环境配置文件是否存在
if [ ! -f ${ENV} ]; then
    cp ${ENV_SAMPLE} ${ENV}
fi


case ${ACTION} in
    "test") # 测试文件/文件夹/全部
        FILE=${2}
        ${PHPUNIT} ${FILE}
    ;;
    "testsuite") # 测试套件
        SUIT_NAME=${2}
        ${PHPUNIT} --testsuite ${SUIT_NAME}
    ;;
    "doc") # 输出文档
        ${PHPDOC}
    ;;

    "rsa")
    len=${2}
    if [ ! -n ${len} ]; then
        len=2048
    fi
    # 生成 RSA 私钥
    openssl genrsa -out ${HOME_DIR}/runtime/rsa_private.key ${len}
    # 生成 RSA 公钥
    openssl rsa -in ${HOME_DIR}/runtime/rsa_private.key -pubout -out ${HOME_DIR}/runtime/rsa_public.key
#    openssl pkcs8 -topk8 -inform PEM -in ${HOME_DIR}/rsa_private.key -outform PEM -nocrypt -out ${HOME_DIR}/private.key
    ;;

esac